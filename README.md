# OBERIG Bot

Бот для хорового колективу OBERIG, який допомагає керувати розкладом подій, нагадуваннями, сповіщеннями YouTube та взаємодією з учасниками у приватних і групових чатах.

## Основні можливості
- Розклад із Google Calendar: перегляд розкладу на сьогодні та деталізація подій.
- Нагадування про події:
  - Щоденні повідомлення з переліком подій на поточний день (після 08:00 за налаштованим часовим поясом).
  - Нагадування за годину до початку події.
  - Розсилка йде і в групові чати, і в особисті чати користувачів, які ввімкнули нагадування.
- Дні народження: генерація текстового привітання та відправка святкового зображення в групові чати.
- Сповіщення про нові відео з YouTube та можливість поширення відео в чати.
- Відгуки від користувачів, аналітика команд, адмін-інструменти.

## Вимоги та встановлення
1) Потрібен Python 3.11+ і pip.
2) Встановіть залежності:

```bash
pip install -r requirements.txt
```

Для розробки (додатково):

```bash
pip install -r requirements.txt -r requirements-dev.txt
```

## Налаштування оточення
Створіть файл `.env` у корені проєкту та додайте змінні:

- `TELEGRAM_TOKEN` — токен вашого бота Telegram.
- `GOOGLE_CREDENTIALS` — шлях до JSON з обліковими даними Google або сам JSON (для календаря й YouTube).
- `CALENDAR_ID` — ID календаря з подіями.
- `YOUTUBE_API_KEY` — ключ API YouTube.
- `OBERIG_PLAYLIST_ID` — ID плейлиста каналу OBERIG.
- `ADMIN_CHAT_ID` — ID чату адміністратора для повідомлень про помилки.
- `DEFAULT_GROUP_CHAT_ID` — ID основного групового чату для сповіщень про нові відео.
- `OPENAI_API_KEY` — ключ OpenAI (необов’язково; для асистента/чатів).
- `OPENAI_ASSISTANT_ID` — ID асистента OpenAI (необов’язково).
- `TIMEZONE` — часовий пояс, наприклад `Europe/Berlin`.
- `REMINDER_TEST_CHAT_ID` — необов’язково; якщо задано, всі нагадування надсилаються тільки в цей чат (режим тестування).
- `BIRTHDAY_IMAGE_ENABLED` — необов’язково; `1` (за замовчуванням) надсилає зображення для днів народження, `0` — тільки текст.

За потреби оновіть файл `oberig_credentials.json` обліковими даними Google.

## Запуск

```bash
python main.py
```

Windows: можна використати скрипти `start_bot.bat` або `start_bot.ps1`.

## Команди для користувачів
- `/start` — запуск бота, меню.
- `/help` — довідка (приватний чат).
- `/rozklad` — розклад на сьогодні (приватний чат).
- `/performances` — графік виступів (приватний чат).
- `/upcoming_birthdays` — найближчі дні народження (приватний чат).
- `/reminder_on` — увімкнути нагадування (приватний чат).
- `/reminder_off` — вимкнути нагадування (приватний чат).
- `/get_sheet` — отримати лист нотаток/даних (приватний чат).
- `/latest_video` — найновіше відео з YouTube (приватний чат).
- `/most_popular_video` — найпопулярніше відео (приватний чат).
- `/top_10_videos` — топ-10 відео (приватний чат).
- `/share_latest` — поділитися найновішим відео.
- `/share_popular` — поділитися популярним відео.
- `/video_notifications_on` і `/video_notifications_off` — вмикання/вимикання сповіщень про відео.

## Адмін-команди
- `/analytics` — аналітика використання команд.
- `/admin_menu` — меню адміністратора.
- `/users_list` — список користувачів.
- `/group_chats_list` — список збережених групових чатів.
- `/delete_messages` — видалити повідомлення бота.
- `/delete_recent` — видалити нещодавні повідомлення.
- `/force_daily_reminder` — примусово надіслати щоденний розклад (ігнорує обмеження).
- `/force_hourly_reminder` — примусово надіслати нагадування за годину (ігнорує обмеження).
- `/force_birthday` — примусова перевірка привітань з днем народження.
- `/force_video_check` — примусова перевірка нових відео та розсилка сповіщень.

## Надсилання нагадувань

- Щоденні нагадування: бот формує заголовок дня і перелік подій на поточну дату та надсилає їх після 08:00 за `TIMEZONE`. Отримувачі:
  - активні групові чати зі списку `group_chats`;
  - особисті чати користувачів зі списку `users_with_reminders` (користувач додає себе командою `/reminder_on`).
- Годинні нагадування: за ~10 хвилинним інтервалом перевіряються події, що починаються протягом наступної години, і надсилаються в ті самі місця (групи та приватні). Для уникнення дублювань використовується хеш контенту події.
- Тестовий режим: якщо встановлено `REMINDER_TEST_CHAT_ID`, усі щоденні та годинні нагадування відправляються лише в цей чат.

## Дні народження
- Перевірка днів народження відбувається щодня та при старті бота.
- Якщо подія містить фразу “день народження”, бот формує привітання та надсилає його у всі активні групові чати.
- Разом із текстом бот надсилає святкове зображення (PNG). Для вимкнення — `BIRTHDAY_IMAGE_ENABLED=0`.

## Тестування

```bash
pip install -r requirements.txt -r requirements-dev.txt
pytest
```

## Примітки
- База даних `bot_data.db` створюється автоматично у корені проєкту.
- Список груп `group_chats` поповнюється, коли бот працює в групі та фіксує її дані.
- Часові налаштування залежать від `TIMEZONE`; за замовчуванням використовується зі змінних середовища.
